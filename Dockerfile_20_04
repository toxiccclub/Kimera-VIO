# Указываем базовый образ для архитектуры ARM64
FROM --platform=linux/arm64 ubuntu:22.04

# Метаданные об обслуживании образа
LABEL maintainer="mabate@mit.edu"

# Устанавливаем переменную окружения, чтобы предотвратить запросы интерактивного ввода
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends apt-utils
RUN apt-get update && \
    apt-get install -y --fix-missing\
      build-essential unzip pkg-config \
      gcc-snapshot \
      cmake \
      gfortran \
      git \
      libtbb-dev \
      libatlas-base-dev \
      libboost-all-dev \
      libeigen3-dev \
      libgflags-dev \
      libgoogle-glog-dev \
      libmetis-dev \
      libopencv-contrib-dev \
      libglfw3-dev \
      build-essential unzip pkg-config \
      libjpeg-dev libpng-dev libtiff-dev \
      libvtk7-dev \
      libgtk-3-dev \
      libparmetis-dev \
      libatlas-base-dev \
      libvtk9-dev \
      qtbase5-dev \
      libqt5opengl5-dev \
      libgl1-mesa-dev \
      pkg-config \
      wget \
      tar \
      xvfb \
      python3 \
      python3-dev \
      python3-pip \
      python3-tk && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Скачиваем и устанавливаем Boost
RUN wget https://boostorg.jfrog.io/artifactory/main/release/1.82.0/source/boost_1_82_0.tar.gz && \
    tar xf boost_1_82_0.tar.gz && \
    rm boost_1_82_0.tar.gz && \
    cd boost_1_82_0 && \
    ./bootstrap.sh --prefix=/usr/local/boost && \
    ./b2 install

# Экспортируем переменную среды BOOST_ROOT
ENV BOOST_ROOT /usr/local/boost

# Копируем патч для DBoW2
COPY .patches/fix_vocab.patch dbow2.patch

# Загружаем версию разработки репозитория GTSAM
ADD https://api.github.com/repos/borglab/gtsam/git/refs/heads/develop version.json

# Клонируем репозиторий GTSAM и устанавливаем его
RUN git clone https://github.com/borglab/gtsam.git && \
    cd gtsam && \
    git checkout 4.2 && \
    mkdir build && \
    cd build && \
    cmake -DCMAKE_SYSTEM_PROCESSOR=arm64 \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DGTSAM_BUILD_WITH_MARCH_NATIVE=OFF \
          -DGTSAM_BUILD_TESTS=OFF \
          -DGTSAM_BUILD_EXAMPLES_ALWAYS=OFF \
          -DCMAKE_BUILD_TYPE=Release \
          -DGTSAM_BUILD_UNSTABLE=ON \
          -DGTSAM_POSE3_EXPMAP=ON \
          -DGTSAM_ROT3_EXPMAP=ON \
          -DGTSAM_TANGENT_PREINTEGRATION=OFF \
          -DGTSAM_USE_SYSTEM_EIGEN=ON \
          -DGTSAM_USE_SYSTEM_METIS=ON \
          -DCMAKE_CXX_FLAGS="-march=armv8-a" \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_VIZ=ON \
          .. && \
    make -j$(nproc) install

# Загружаем версию разработки репозитория Open_GV
RUN git clone https://github.com/toxiccclub/opengv.git && \
    cd opengv && \
    git apply march_native_disable.patch && \
    mkdir build && \
    cd build && \
    cmake -DCMAKE_SYSTEM_PROCESSOR=arm64 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DCMAKE_CXX_FLAGS="-march=armv8-a" \
          .. && \
    make -j$(nproc) install

# Клонируем репозиторий DBoW2 и устанавливаем его
RUN git clone https://github.com/dorian3d/DBoW2.git && \
    cd DBoW2 && \
    git apply ../dbow2.patch && \
    mkdir build && \
    cd build && \
    cmake -DCMAKE_SYSTEM_PROCESSOR=arm64 \
          -DCMAKE_CXX_FLAGS="-march=armv8-a" \
          -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_BUILD_TYPE=Release \
          .. && \
    make -j$(nproc) install

# Загружаем версию разработки репозитория RobustPGO
ADD https://api.github.com/repos/MIT-SPARK/Kimera-RPGO/git/refs/heads/master version.json
RUN git clone https://github.com/MIT-SPARK/Kimera-RPGO.git && \
    cd Kimera-RPGO && \
    mkdir build && \
    cd build && \
    cmake -DCMAKE_SYSTEM_PROCESSOR=arm64 \
          -DCMAKE_CXX_FLAGS="-march=armv8-a" \
          -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_BUILD_TYPE=Release \
          ..  && \
    make -j$(nproc) install

# Установка зависимостей OpenCV
RUN apt-get update && \
    apt-get install -y \
    libopenjpip7 \
    libopenjp2-tools \
    libopenjpip-dec-server \
    libopenjpip-server

# Клонирование репозиториев OpenCV и OpenCV_contrib
RUN git clone https://github.com/opencv/opencv.git && \
    git clone https://github.com/opencv/opencv_contrib.git && \
    cd opencv_contrib && \
    git checkout tags/4.5.5 && \
    cd .. && \
    cd opencv && \
    git checkout tags/4.5.5

# Создание и переход в каталог сборки
RUN mkdir -p opencv/build && \
    cd opencv/build

# Настройка сборки OpenCV с помощью CMake
RUN cd opencv/build && \
    cmake \
    -DCMAKE_SYSTEM_PROCESSOR=arm64 \
    -DCMAKE_CXX_FLAGS="-march=armv8-a" \
    -DCMAKE_INSTALL_PREFIX=/usr/local \
    -DCMAKE_BUILD_TYPE=Release \
    -DWITH_TBB=ON \
    -DWITH_VTK=ON \
    -DBUILD_VIZ=ON \
    -DOPENCV_EXTRA_MODULES_PATH=/opencv_contrib/modules \
    .. && \
make -j$(nproc) install

# Install Kimera-VIO-Evaluation
RUN python3 -m pip install --upgrade pip
ADD https://api.github.com/repos/MIT-SPARK/Kimera-VIO-Evaluation/git/refs/heads/fix/python3 version.json
RUN python3 -m pip install git+https://github.com/MIT-SPARK/Kimera-VIO-Evaluation.git@fix/python3
